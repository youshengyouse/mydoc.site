{"version":3,"file":"ssr-server.js","sources":["../../../src/ssr/ssr-server.ts"],"sourcesContent":["import { crossSerializeStream, getCrossReferenceHeader } from 'seroval'\nimport { ReadableStreamPlugin } from 'seroval-plugins/web'\nimport invariant from 'tiny-invariant'\nimport { createControlledPromise } from '../utils'\nimport minifiedTsrBootStrapScript from './tsrScript?script-string'\nimport { ShallowErrorPlugin } from './seroval-plugins'\nimport type { AnyRouter } from '../router'\nimport type { DehydratedMatch } from './ssr-client'\nimport type { DehydratedRouter } from './client'\nimport type { AnyRouteMatch } from '../Matches'\nimport type { Manifest } from '../manifest'\n\ndeclare module '../router' {\n  interface ServerSsr {\n    setRenderFinished: () => void\n  }\n  interface RouterEvents {\n    onInjectedHtml: {\n      type: 'onInjectedHtml'\n      promise: Promise<string>\n    }\n  }\n}\n\nexport const GLOBAL_TSR = '$_TSR'\nconst SCOPE_ID = 'tsr'\n\nexport function dehydrateMatch(match: AnyRouteMatch): DehydratedMatch {\n  const dehydratedMatch: DehydratedMatch = {\n    i: match.id,\n    u: match.updatedAt,\n    s: match.status,\n  }\n\n  const properties = [\n    ['__beforeLoadContext', 'b'],\n    ['loaderData', 'l'],\n    ['error', 'e'],\n    ['ssr', 'ssr'],\n  ] as const\n\n  for (const [key, shorthand] of properties) {\n    if (match[key] !== undefined) {\n      dehydratedMatch[shorthand] = match[key]\n    }\n  }\n  return dehydratedMatch\n}\n\nexport function attachRouterServerSsrUtils(\n  router: AnyRouter,\n  manifest: Manifest | undefined,\n) {\n  router.ssr = {\n    manifest,\n  }\n  const serializationRefs = new Map<unknown, number>()\n\n  let initialScriptSent = false\n  const getInitialScript = () => {\n    if (initialScriptSent) {\n      return ''\n    }\n    initialScriptSent = true\n    return `${getCrossReferenceHeader(SCOPE_ID)};${minifiedTsrBootStrapScript};`\n  }\n  let _dehydrated = false\n  const listeners: Array<() => void> = []\n\n  router.serverSsr = {\n    injectedHtml: [],\n    injectHtml: (getHtml) => {\n      const promise = Promise.resolve().then(getHtml)\n      router.serverSsr!.injectedHtml.push(promise)\n      router.emit({\n        type: 'onInjectedHtml',\n        promise,\n      })\n\n      return promise.then(() => {})\n    },\n    injectScript: (getScript) => {\n      return router.serverSsr!.injectHtml(async () => {\n        const script = await getScript()\n        return `<script class='$tsr'>${getInitialScript()}${script};if (typeof $_TSR !== 'undefined') $_TSR.c()</script>`\n      })\n    },\n    dehydrate: async () => {\n      invariant(!_dehydrated, 'router is already dehydrated!')\n      let matchesToDehydrate = router.state.matches\n      if (router.isShell()) {\n        // In SPA mode we only want to dehydrate the root match\n        matchesToDehydrate = matchesToDehydrate.slice(0, 1)\n      }\n      const matches = matchesToDehydrate.map(dehydrateMatch)\n\n      const dehydratedRouter: DehydratedRouter = {\n        manifest: router.ssr!.manifest,\n        matches,\n      }\n      const lastMatchId = matchesToDehydrate[matchesToDehydrate.length - 1]?.id\n      if (lastMatchId) {\n        dehydratedRouter.lastMatchId = lastMatchId\n      }\n      dehydratedRouter.dehydratedData = await router.options.dehydrate?.()\n      _dehydrated = true\n\n      const p = createControlledPromise<string>()\n      crossSerializeStream(dehydratedRouter, {\n        refs: serializationRefs,\n        // TODO make plugins configurable\n        plugins: [ReadableStreamPlugin, ShallowErrorPlugin],\n        onSerialize: (data, initial) => {\n          const serialized = initial ? `${GLOBAL_TSR}[\"router\"]=` + data : data\n          router.serverSsr!.injectScript(() => serialized)\n        },\n        scopeId: SCOPE_ID,\n        onDone: () => p.resolve(''),\n        onError: (err) => p.reject(err),\n      })\n      // make sure the stream is kept open until the promise is resolved\n      router.serverSsr!.injectHtml(() => p)\n    },\n    isDehydrated() {\n      return _dehydrated\n    },\n    onRenderFinished: (listener) => listeners.push(listener),\n    setRenderFinished: () => {\n      listeners.forEach((l) => l())\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAwBO,MAAM,aAAa;AAC1B,MAAM,WAAW;AAEV,SAAS,eAAe,OAAuC;AACpE,QAAM,kBAAmC;AAAA,IACvC,GAAG,MAAM;AAAA,IACT,GAAG,MAAM;AAAA,IACT,GAAG,MAAM;AAAA,EACX;AAEA,QAAM,aAAa;AAAA,IACjB,CAAC,uBAAuB,GAAG;AAAA,IAC3B,CAAC,cAAc,GAAG;AAAA,IAClB,CAAC,SAAS,GAAG;AAAA,IACb,CAAC,OAAO,KAAK;AAAA,EACf;AAEA,aAAW,CAAC,KAAK,SAAS,KAAK,YAAY;AACrC,QAAA,MAAM,GAAG,MAAM,QAAW;AACZ,sBAAA,SAAS,IAAI,MAAM,GAAG;AAAA,IAAA;AAAA,EACxC;AAEK,SAAA;AACT;AAEgB,SAAA,2BACd,QACA,UACA;AACA,SAAO,MAAM;AAAA,IACX;AAAA,EACF;AACM,QAAA,wCAAwB,IAAqB;AAEnD,MAAI,oBAAoB;AACxB,QAAM,mBAAmB,MAAM;AAC7B,QAAI,mBAAmB;AACd,aAAA;AAAA,IAAA;AAEW,wBAAA;AACpB,WAAO,GAAG,wBAAwB,QAAQ,CAAC,IAAI,0BAA0B;AAAA,EAC3E;AACA,MAAI,cAAc;AAClB,QAAM,YAA+B,CAAC;AAEtC,SAAO,YAAY;AAAA,IACjB,cAAc,CAAC;AAAA,IACf,YAAY,CAAC,YAAY;AACvB,YAAM,UAAU,QAAQ,QAAQ,EAAE,KAAK,OAAO;AACvC,aAAA,UAAW,aAAa,KAAK,OAAO;AAC3C,aAAO,KAAK;AAAA,QACV,MAAM;AAAA,QACN;AAAA,MAAA,CACD;AAEM,aAAA,QAAQ,KAAK,MAAM;AAAA,MAAA,CAAE;AAAA,IAC9B;AAAA,IACA,cAAc,CAAC,cAAc;AACpB,aAAA,OAAO,UAAW,WAAW,YAAY;AACxC,cAAA,SAAS,MAAM,UAAU;AAC/B,eAAO,wBAAwB,iBAAkB,CAAA,GAAG,MAAM;AAAA,MAAA,CAC3D;AAAA,IACH;AAAA,IACA,WAAW,YAAY;;AACX,gBAAA,CAAC,aAAa,+BAA+B;AACnD,UAAA,qBAAqB,OAAO,MAAM;AAClC,UAAA,OAAO,WAAW;AAEC,6BAAA,mBAAmB,MAAM,GAAG,CAAC;AAAA,MAAA;AAE9C,YAAA,UAAU,mBAAmB,IAAI,cAAc;AAErD,YAAM,mBAAqC;AAAA,QACzC,UAAU,OAAO,IAAK;AAAA,QACtB;AAAA,MACF;AACA,YAAM,eAAc,wBAAmB,mBAAmB,SAAS,CAAC,MAAhD,mBAAmD;AACvE,UAAI,aAAa;AACf,yBAAiB,cAAc;AAAA,MAAA;AAEjC,uBAAiB,iBAAiB,QAAM,kBAAO,SAAQ,cAAf;AAC1B,oBAAA;AAEd,YAAM,IAAI,wBAAgC;AAC1C,2BAAqB,kBAAkB;AAAA,QACrC,MAAM;AAAA;AAAA,QAEN,SAAS,CAAC,sBAAsB,kBAAkB;AAAA,QAClD,aAAa,CAAC,MAAM,YAAY;AAC9B,gBAAM,aAAa,UAAU,GAAG,UAAU,gBAAgB,OAAO;AAC1D,iBAAA,UAAW,aAAa,MAAM,UAAU;AAAA,QACjD;AAAA,QACA,SAAS;AAAA,QACT,QAAQ,MAAM,EAAE,QAAQ,EAAE;AAAA,QAC1B,SAAS,CAAC,QAAQ,EAAE,OAAO,GAAG;AAAA,MAAA,CAC/B;AAEM,aAAA,UAAW,WAAW,MAAM,CAAC;AAAA,IACtC;AAAA,IACA,eAAe;AACN,aAAA;AAAA,IACT;AAAA,IACA,kBAAkB,CAAC,aAAa,UAAU,KAAK,QAAQ;AAAA,IACvD,mBAAmB,MAAM;AACvB,gBAAU,QAAQ,CAAC,MAAM,EAAA,CAAG;AAAA,IAAA;AAAA,EAEhC;AACF;"}